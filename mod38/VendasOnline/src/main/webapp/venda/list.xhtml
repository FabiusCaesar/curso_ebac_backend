<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<f:view>
  <h:head>
    <title>Vendas</title>

    <h:outputStylesheet>
      :root { --label-w: 180px; }

      .page { max-width: 1400px; margin: 0 auto; padding: 1.5rem 1rem 3rem; }
      .title { margin: .5rem 0 1rem; text-align: center; }
      .right { text-align: right; }
      .left  { text-align: left; } /* usado na coluna Cliente */
      .total { font-weight: 700; font-size: 1.1rem; }
      .total .label { margin-right: .25rem; }

      /* 2 colunas: form um pouco menor, lista um pouco maior */
      .two-col {
        display: grid;
        grid-template-columns: minmax(500px, 1.3fr) minmax(520px, 1.7fr);
        gap: 1rem;
      }
      @media (max-width: 1100px) { .two-col { grid-template-columns: 1fr; } }

      /* Grids consistentes p/ labels + inputs */
      .form-grid,
      .form-grid-2 {
        display: grid;
        grid-template-columns: var(--label-w) 1fr;
        grid-column-gap: 1rem;
        grid-row-gap: .75rem;
        align-items: center;
      }
      @media (max-width: 800px) {
        .form-grid, .form-grid-2 { grid-template-columns: 1fr; }
      }

      .form-grid .ui-outputlabel,
      .form-grid-2 .ui-outputlabel { align-self: center; }

      .form-grid .ui-inputfield, .form-grid-2 .ui-inputfield,
      .form-grid .ui-inputtext,  .form-grid-2 .ui-inputtext { width: 100%; box-sizing: border-box; }

      .form-grid .ui-autocomplete, .form-grid-2 .ui-autocomplete { width: 100%; }
      .form-grid .ui-autocomplete-input, .form-grid-2 .ui-autocomplete-input { width: 100%; box-sizing: border-box; }

      .form-grid .ui-inputnumber input, .form-grid-2 .ui-inputnumber input { width: 100%; box-sizing: border-box; }

      .form-grid .ui-datepicker input, .form-grid-2 .ui-datepicker input,
      .form-grid .ui-calendar input,  .form-grid-2 .ui-calendar input { width: 100%; box-sizing: border-box; }

      /* Linha de ações dos itens */
      .actions {
        display: grid;
        grid-template-columns: var(--label-w) 1fr 1fr;
        grid-column-gap: 1rem;
        margin-top: .75rem;
        margin-bottom: .75rem;  /* respiro antes da tabela de itens */
        align-items: stretch;
      }
      .actions .spacer { display: block; }
      .actions .ui-button { width: 100%; }

      /* Botões finais do formulário com espaçamento */
      .submit-actions {
        display: flex;
        justify-content: flex-end;
        gap: .75rem;
        flex-wrap: wrap;
        margin-top: .5rem;
      }

      /* ===== Botões ícone-apenas na lista de vendas ===== */
      .row-actions{
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: .5rem;         /* espaço entre os botões */
        flex-wrap: wrap;
      }

      /* Centralização perfeita do ícone (cobre PF 8+ e PrimeOne) */
      .btn-icon.ui-button{
        display: inline-flex;         /* vira um flex container */
        align-items: center;
        justify-content: center;
        padding: 0;                   /* você removeu o padding */
        width: 2.25rem;               /* largura/altura fixas e iguais */
        height: 2.25rem;
        line-height: 1;
      }
      /* esconder span de texto vazio que alguns temas ainda rendereizam */
      .btn-icon .ui-button-text{ display: none; }

      /* neutralizar posicionamento absoluto do span do ícone nas versões antigas */
      .btn-icon .ui-button-icon,
      .btn-icon .ui-button-icon-left,
      .btn-icon .ui-button-icon-right{
        position: static;
        margin: 0;
      }

      /* Tabela de vendas com largura mínima confortável */
      .vendas-table { min-width: 700px; }
      .no-wrap { white-space: nowrap; }
    </h:outputStylesheet>
  </h:head>

  <h:body>
    <!-- Menubar -->
    <h:form id="menuForm">
      <ui:include src="/WEB-INF/includes/menubar.xhtml" />
    </h:form>

    <div class="page">
      <p:growl id="growl" showDetail="true" life="3000" />

      <div class="two-col">
        <!-- COLUNA ESQUERDA: FORM NOVA/EDIÇÃO DE VENDA -->
        <div>
          <h2 class="title">#{vendaController.isUpdate ? 'Atualizar Venda' : 'Nova Venda'}</h2>

          <h:form id="formVenda">
            <!-- DADOS DA VENDA -->
            <p:panel header="Dados da Venda" toggleable="true" collapsed="false" toggleSpeed="150">
              <div class="form-grid">
                <p:outputLabel for="cliente" value="Cliente" />
                <p:autoComplete id="cliente"
                                value="#{vendaController.venda.cliente}"
                                completeMethod="#{vendaController.filtrarClientes}"
                                var="c" itemLabel="#{c.nome} - #{c.cpf}" itemValue="#{c}"
                                dropdown="true" forceSelection="true"
                                converter="clienteConverter"
                                placeholder="Busque por nome ou CPF" />

                <p:outputLabel for="data" value="Data da venda" />
                <p:datePicker id="data" value="#{vendaController.dataVenda}" showIcon="true" />
              </div>
            </p:panel>

            <p:spacer height="10" />

            <!-- ITENS DA VENDA -->
            <p:panel header="Itens da Venda" toggleable="true" collapsed="false" toggleSpeed="150">
              <div class="form-grid-2">
                <p:outputLabel for="produto" value="Produto" />
                <p:autoComplete id="produto"
                                value="#{vendaController.produtoSelecionado}"
                                completeMethod="#{vendaController.filtrarProdutos}"
                                var="prod" itemLabel="#{prod.nome} (#{prod.codigo}) - #{prod.modelo}"
                                itemValue="#{prod}"
                                dropdown="true" forceSelection="true"
                                converter="produtoConverter"
                                placeholder="Busque por nome, código, modelo ou descrição" />

                <p:outputLabel for="qtd" value="Quantidade" />
                <p:inputNumber id="qtd" value="#{vendaController.quantidadeProduto}"
                               minValue="1" decimalPlaces="0" />
              </div>

              <div class="actions">
                <span class="spacer" aria-hidden="true"></span>
                <p:commandButton value="Adicionar"
                                 action="#{vendaController.adicionarProduto}"
                                 update=":formVenda:tabelaItens :formVenda:total :growl"
                                 icon="pi pi-plus" />
                <p:commandButton value="Remover"
                                 action="#{vendaController.removerProduto}"
                                 update=":formVenda:tabelaItens :formVenda:total :growl"
                                 icon="pi pi-minus"
                                 styleClass="ui-button-secondary" />
              </div>

              <p:dataTable id="tabelaItens" value="#{vendaController.venda.produtos}" var="pq"
                           emptyMessage="Nenhum item adicionado"
                           responsiveLayout="scroll">
                <p:column headerText="Código" style="width:50px" styleClass="right">
                  <h:outputText value="#{pq.produto.codigo}" />
                </p:column>
                <p:column headerText="Produto">
                  <h:outputText value="#{pq.produto.nome}" />
                </p:column>
                <p:column headerText="Quant." style="width:40px" styleClass="right">
                  <h:outputText value="#{pq.quantidade}" />
                </p:column>
                <p:column headerText="Valor" style="width:100px" styleClass="right">
                  <h:outputText value="#{pq.valorTotal}">
                    <f:convertNumber type="currency" currencySymbol="R$ " />
                  </h:outputText>
                </p:column>
                <p:column headerText="Ações" style="min-width: 220px;" styleClass="right no-wrap">
                  <p:commandButton value="Remover"
                                   action="#{vendaController.removerProduto(pq)}"
                                   update=":formVenda:tabelaItens :formVenda:total :growl"
                                   icon="pi pi-trash"
                                   styleClass="ui-button-danger" />
                </p:column>
              </p:dataTable>

              <h:panelGroup id="total" styleClass="right total" layout="block" style="margin-top:.75rem;">
                <span class="label">Total:</span>
                <h:outputText value="#{vendaController.venda.valorTotal}">
                  <f:convertNumber type="currency" currencySymbol="R$ " />
                </h:outputText>
              </h:panelGroup>
            </p:panel>

            <p:spacer height="10" />

            <!-- botões finais com espaçamento -->
            <div class="submit-actions">
              <p:commandButton value="#{vendaController.isUpdate ? 'Salvar alterações' : 'Cadastrar venda'}"
                               action="#{vendaController.salvar}"
                               update=":formVenda :formVenda:tabelaItens :formVenda:total :growl :formTabelaVendas:tabelaVendas"
                               icon="pi pi-check" />
              <p:commandButton value="Cancelar edição"
                               action="#{vendaController.cancel}"
                               update=":formVenda :formVenda:tabelaItens :formVenda:total :growl"
                               icon="pi pi-times" styleClass="ui-button-secondary" />
            </div>

          </h:form>
        </div>

        <!-- COLUNA DIREITA: LISTA DE VENDAS -->
        <div>
          <h2 class="title">Vendas cadastradas</h2>
          <h:form id="formTabelaVendas">
            <p:dataTable id="tabelaVendas" value="#{vendaController.vendas}" var="vend"
                         paginator="true" rows="8" emptyMessage="Nenhuma venda cadastrada"
                         responsiveLayout="scroll"
                         styleClass="vendas-table">
              <p:column headerText="Código" style="width:80px" styleClass="right">
                <h:outputText value="#{vend.codigo}" />
              </p:column>
              <p:column headerText="Cliente" style="width:60px" styleClass="left">
                <h:outputText value="#{vend.cliente.nome}" />
              </p:column>
              <p:column headerText="Data" style="width:80px" styleClass="right">
                <h:outputText value="#{vendaController.toDate(vend.dataVenda)}">
                  <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Campo_Grande"/>
                </h:outputText>
              </p:column>
              <p:column headerText="Status" style="width:80px">
                <h:outputText value="#{vend.status}" />
              </p:column>
              <p:column headerText="Total" style="width:100px" styleClass="right">
                <h:outputText value="#{vend.valorTotal}">
                  <f:convertNumber type="currency" currencySymbol="R$ " />
                </h:outputText>
              </p:column>

              <!-- AÇÕES: ícone-apenas centralizado -->
              <p:column headerText="Ações" style="min-width: 220px;" styleClass="right no-wrap">
                <div class="row-actions">
                  <p:commandButton id="btnEditar"
                                   value=""
                                   title="Editar"
                                   action="#{vendaController.edit(vend)}"
                                   update=":formVenda :formVenda:tabelaItens :formVenda:total :growl"
                                   icon="pi pi-pencil"
                                   styleClass="btn-icon" />
                  <p:commandButton id="btnFinalizar"
                                   value=""
                                   title="Finalizar"
                                   action="#{vendaController.finalizar(vend)}"
                                   update=":formTabelaVendas :growl"
                                   icon="pi pi-check"
                                   styleClass="btn-icon ui-button-success" />
                  <p:commandButton id="btnCancelar"
                                   value=""
                                   title="Cancelar venda"
                                   action="#{vendaController.delete(vend)}"
                                   update=":formTabelaVendas :growl"
                                   icon="pi pi-times"
                                   styleClass="btn-icon ui-button-danger" />
                </div>
              </p:column>
            </p:dataTable>
          </h:form>
        </div>
      </div>
    </div>
  </h:body>
</f:view>
</html>
