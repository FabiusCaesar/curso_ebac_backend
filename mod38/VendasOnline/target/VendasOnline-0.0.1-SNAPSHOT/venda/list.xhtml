<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<f:view>
  <h:head>
    <title>Vendas</title>

    <!-- Normalização visual e grid consistente p/ labels + inputs -->
    <h:outputStylesheet>
      :root { --label-w: 180px; }

      .page { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem 3rem; }
      .title { margin: .5rem 0 1rem; text-align: center; }
      .right { text-align: right; }
      .total { font-weight: 700; font-size: 1.1rem; }
      .total .label { margin-right: .25rem; }

      /* Grids consistentes independentes do tema/primeflex */
      .form-grid {
        display: grid;
        grid-template-columns: var(--label-w) 1fr;
        grid-column-gap: 1rem;
        grid-row-gap: .75rem;
        align-items: center; /* alinha label e input verticalmente */
      }
      .form-grid-2 {
        display: grid;
        grid-template-columns: var(--label-w) 1fr var(--label-w) 1fr;
        grid-column-gap: 1rem;
        grid-row-gap: .75rem;
        align-items: center;
      }
      @media (max-width: 800px) {
        .form-grid,
        .form-grid-2 { grid-template-columns: 1fr; }
      }

      /* Labels */
      .form-grid .ui-outputlabel,
      .form-grid-2 .ui-outputlabel { align-self: center; }

      /* Inputs PrimeFaces ocupam 100% e alinham com labels */
      .form-grid .ui-inputfield,
      .form-grid-2 .ui-inputfield,
      .form-grid .ui-inputtext,
      .form-grid-2 .ui-inputtext { width: 100%; box-sizing: border-box; }

      /* AutoComplete */
      .form-grid .ui-autocomplete,
      .form-grid-2 .ui-autocomplete { width: 100%; }
      .form-grid .ui-autocomplete-input,
      .form-grid-2 .ui-autocomplete-input { width: 100%; box-sizing: border-box; }

      /* InputNumber */
      .form-grid .ui-inputnumber input,
      .form-grid-2 .ui-inputnumber input { width: 100%; box-sizing: border-box; }

      /* DatePicker / Calendar */
      .form-grid .ui-datepicker input,
      .form-grid-2 .ui-datepicker input,
      .form-grid .ui-calendar input,
      .form-grid-2 .ui-calendar input { width: 100%; box-sizing: border-box; }

      /* SelectOneMenu / Dropdown (se usar em algum ponto) */
      .form-grid .ui-selectonemenu,
      .form-grid-2 .ui-selectonemenu { width: 100%; box-sizing: border-box; }

      /* Botões da linha de ações dos itens */
      .actions { text-align: right; }
      .mt-sm { margin-top: .75rem; }
    </h:outputStylesheet>
  </h:head>

  <h:body>
    <!-- Menubar -->
    <h:form id="menuForm">
      <ui:include src="/WEB-INF/includes/menubar.xhtml" />
    </h:form>

    <div class="page">
      <p:growl id="growl" showDetail="true" life="3000" />

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <!-- COLUNA ESQUERDA: FORM NOVA/EDIÇÃO DE VENDA -->
        <div>
          <h2 class="title">#{vendaController.isUpdate ? 'Atualizar Venda' : 'Nova Venda'}</h2>

          <h:form id="formVenda">
            <!-- DADOS DA VENDA -->
            <p:panel header="Dados da Venda" toggleable="true" collapsed="false" toggleSpeed="150">
              <!-- usamos nossa grid em vez do layout do panelGrid -->
              <div class="form-grid">
                <!-- Cliente -->
                <p:outputLabel for="cliente" value="Cliente" />
                <p:autoComplete id="cliente"
                                value="#{vendaController.venda.cliente}"
                                completeMethod="#{vendaController.filtrarClientes}"
                                var="c" itemLabel="#{c.nome} - #{c.cpf}" itemValue="#{c}"
                                dropdown="true" forceSelection="true"
                                converter="clienteConverter"
                                placeholder="Busque por nome ou CPF" />

                <!-- Data da Venda -->
                <p:outputLabel for="data" value="Data da venda" />
                <p:datePicker id="data" value="#{vendaController.dataVenda}" showIcon="true" />
              </div>
            </p:panel>

            <p:spacer height="10" />

            <!-- ITENS DA VENDA -->
            <p:panel header="Itens da Venda" toggleable="true" collapsed="false" toggleSpeed="150">
              <div class="form-grid-2">
                <!-- Produto -->
                <p:outputLabel for="produto" value="Produto" />
                <p:autoComplete id="produto"
                                value="#{vendaController.produtoSelecionado}"
                                completeMethod="#{vendaController.filtrarProdutos}"
                                var="prod" itemLabel="#{prod.nome} (#{prod.codigo}) - #{prod.modelo}"
                                itemValue="#{prod}"
                                dropdown="true" forceSelection="true"
                                converter="produtoConverter"
                                placeholder="Busque por nome, código, modelo ou descrição" />

                <!-- Quantidade -->
                <p:outputLabel for="qtd" value="Quantidade" />
                <p:inputNumber id="qtd" value="#{vendaController.quantidadeProduto}"
                               minValue="1" decimalPlaces="0" />
              </div>

              <div class="actions mt-sm">
                <p:commandButton value="Adicionar"
                                 action="#{vendaController.adicionarProduto}"
                                 update=":formVenda:tabelaItens :formVenda:total :growl"
                                 icon="pi pi-plus" />
                <p:commandButton value="Remover"
                                 action="#{vendaController.removerProduto}"
                                 update=":formVenda:tabelaItens :formVenda:total :growl"
                                 icon="pi pi-minus"
                                 styleClass="ui-button-secondary" />
              </div>

              <!-- Tabela de Itens -->
              <p:dataTable id="tabelaItens" value="#{vendaController.venda.produtos}" var="pq"
                           emptyMessage="Nenhum item adicionado"
                           responsiveLayout="scroll">
                <p:column headerText="Código" styleClass="right">
                  <h:outputText value="#{pq.produto.codigo}" />
                </p:column>
                <p:column headerText="Produto">
                  <h:outputText value="#{pq.produto.nome}" />
                </p:column>
                <p:column headerText="Quantidade" styleClass="right">
                  <h:outputText value="#{pq.quantidade}" />
                </p:column>
                <p:column headerText="Valor do Item" styleClass="right">
                  <h:outputText value="#{pq.valorTotal}">
                    <f:convertNumber type="currency" currencySymbol="R$ " />
                  </h:outputText>
                </p:column>
                <p:column headerText="Ações" styleClass="right">
                  <p:commandButton value="Remover linha"
                                   action="#{vendaController.removerProduto(pq)}"
                                   update=":formVenda:tabelaItens :formVenda:total :growl"
                                   icon="pi pi-trash"
                                   styleClass="ui-button-danger" />
                </p:column>
              </p:dataTable>

              <!-- Total -->
              <h:panelGroup id="total" styleClass="right total" layout="block" style="margin-top:.75rem;">
                <span class="label">Total:</span>
                <h:outputText value="#{vendaController.venda.valorTotal}">
                  <f:convertNumber type="currency" currencySymbol="R$ " />
                </h:outputText>
              </h:panelGroup>
            </p:panel>

            <p:spacer height="10" />
            <div class="right">
              <p:commandButton value="#{vendaController.isUpdate ? 'Salvar alterações' : 'Cadastrar venda'}"
                               action="#{vendaController.salvar}"
                               update=":formVenda :formVenda:tabelaItens :formVenda:total :growl :formTabelaVendas:tabelaVendas"
                               icon="pi pi-check" />
              <p:commandButton value="Cancelar edição"
                               action="#{vendaController.cancel}"
                               update=":formVenda :formVenda:tabelaItens :formVenda:total :growl"
                               icon="pi pi-times" styleClass="ui-button-secondary" />
            </div>

          </h:form>
        </div>

        <!-- COLUNA DIREITA: LISTA DE VENDAS -->
        <div>
          <h2 class="title">Vendas cadastradas</h2>
          <h:form id="formTabelaVendas">
            <p:dataTable id="tabelaVendas" value="#{vendaController.vendas}" var="vend"
                         paginator="true" rows="8" emptyMessage="Nenhuma venda cadastrada"
                         responsiveLayout="scroll">
              <p:column headerText="Código" styleClass="right">
                <h:outputText value="#{vend.codigo}" />
              </p:column>
              <p:column headerText="Cliente">
                <h:outputText value="#{vend.cliente.nome}" />
              </p:column>
              <p:column headerText="Data" styleClass="right">
                <h:outputText value="#{vendaController.toDate(vend.dataVenda)}">
                  <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Campo_Grande"/>
                </h:outputText>
              </p:column>
              <p:column headerText="Status">
                <h:outputText value="#{vend.status}" />
              </p:column>
              <p:column headerText="Total" styleClass="right">
                <h:outputText value="#{vend.valorTotal}">
                  <f:convertNumber type="currency" currencySymbol="R$ " />
                </h:outputText>
              </p:column>
              <p:column headerText="Ações" styleClass="right">
                <p:commandButton value="Editar"
                                 action="#{vendaController.edit(vend)}"
                                 update=":formVenda :formVenda:tabelaItens :formVenda:total :growl"
                                 icon="pi pi-pencil" />
                <p:commandButton value="Finalizar"
                                 action="#{vendaController.finalizar(vend)}"
                                 update=":formTabelaVendas :growl"
                                 icon="pi pi-check"
                                 styleClass="ui-button-success" />
                <p:commandButton value="Cancelar"
                                 action="#{vendaController.delete(vend)}"
                                 update=":formTabelaVendas :growl"
                                 icon="pi pi-times"
                                 styleClass="ui-button-danger" />
              </p:column>
            </p:dataTable>
          </h:form>
        </div>
      </div>
    </div>
  </h:body>
</f:view>
</html>
